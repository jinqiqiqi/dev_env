;; (require 'sawfish.wm.ext.pager)
;; (add-hook 'after-initialization-hook pager t)
(setq load-path (cons "/usr/share/sawfish/lisp/sawfish/wm/commands/"
					  load-path))
(require 'jump-or-exec)
(require 'rep.io.timers)

(defun eric-display-msg (message &optional seconds)
  "display message for seconds seconds and make the message disappeared."
  (interactive)
  (display-message message)
  (make-timer
   (lambda ()
	 (display-message))
   (or seconds 3)))


(defun volume-change (ops exps)
  (interactive)
  (let* ((res-stream (make-string-output-stream))
		 (proc (make-process res-stream))
		 (res-str))
	(call-process proc nil "amixer" "sset" "Master" ops)
	(setq res-str (get-output-stream-string res-stream))
	(string-match exps res-str)
	(eric-display-msg (concat "Volume: " (expand-last-match "\\1")) 5)))
	
(defun eric-joe (app keywords msg)
  (interactive)
  (jump-or-exec keywords
				 (lambda()
				   (eric-display-msg msg)
				   (system app)
				   "sleep 10")
				 (lambda(wind)
				   (display-window wind)
				   )))

(bind-keys global-keymap
		   "Super-O" '(eric-joe "opera &" "Opera" "starting Opera..."))

(bind-keys global-keymap
		   "Super-T" '(eric-joe "gnome-terminal &" ":~" "starting Terminal..."))

(bind-keys global-keymap
		   "Super-E" '(eric-joe "emacs &" "Emacs" "starting Emacs..."))

(bind-keys global-keymap
		   "Super-F" '(eric-joe "firefox &" "Mozilla Firefox" "starting Firefox..."))

(bind-keys global-keymap
		   "Super-L" '((system "xscreensaver-command -activate")
					   (eric-display-msg "Locking workstation...")))

(bind-keys global-keymap
		   "XF86AudioLowerVolume" '(volume-change "5%-" ".*?\\[([^%]*%)\\].*"))
(bind-keys global-keymap
		   "XF86AudioRaiseVolume" '(volume-change "5%+" ".*?\\[([^%]*%)\\].*"))
(bind-keys global-keymap
		   "XF86AudioMute" '(volume-change "toggle" ".*\\[(on|off)\\].*"))

;; application keymacros
(define apps-keymap (make-keymap))
(bind-keys global-keymap "Super-j" apps-keymap)
(bind-keys apps-keymap
		   "o" '(jump-or-exec "Opera" "opera" t)
		   "l" '(jump-or-exec "xscreen" "xscreensaver-command -activate" t)
		   "t" '(jump-or-exec ":~" "gnome-terminal" t)
		   "d" '(jump-or-exec "StarDict" "stardict" t)
		   "e" '(jump-or-exec "Emacs" "emacs" t)
		   "k" '(jump-or-exec "Skype" "skype" t)
		   "b" '(jump-or-exec "LibreOffice" "libreoffice" t)
		   "f" '(jump-or-exec "Firefox" "firefox" t)
		   "y" '(jump-or-exec "Synergy" "synergy" t)
		   "v" '(jump-or-exec "TeamViewer" "teamviewer" t)
		   "r" '(jump-or-exec "GNOME Commander" "gnome-commander" t)
		   )

(setq startup-programs
	  '(
		("fbpanel")
		("fcitx")
		("nm-applet")
		("megasync")
		("skypeforlinux")
		("slack")
		("synapse")
		("synergy")
		("teamviewer")
		("xscreensaver")
		))

(mapc (lambda (program)
		(apply start-process (make-process standard-output) program))
	  startup-programs)

(add-hook 'before-exit-hook
		  (lambda ()
			(mapc stop-process (active-processes))))
